#!/usr/bin/env bash
# Jobsprint Main Menu
# Central hub for all Jobsprint TUI operations

set -euo pipefail

# Source configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/config.sh"

# Script metadata
readonly SCRIPT_NAME="jobsprint"
readonly SCRIPT_VERSION="1.0.0"

# Display welcome banner
show_banner() {
    gum style \
        --foreground="${COLOR_PRIMARY}" \
        --border double \
        --border-foreground="${COLOR_PRIMARY}" \
        --align center \
        --padding "2 4" \
        --margin "1 2" \
        --bold \
        "JOBBSPRINT" > /dev/tty

    gum style \
        --foreground="${COLOR_MUTED}" \
        --align center \
        --margin "0 2" \
        "AI Automation Platform v${SCRIPT_VERSION}" > /dev/tty
}

# Display help
show_main_help() {
    show_help "${SCRIPT_NAME}" "Jobsprint AI Automation Platform" \
        "Central management interface for Jobsprint services and workflows." \
        "" \
        "Available commands:" \
        "  start    - Start all Jobsprint services" \
        "  stop     - Stop all Jobsprint services" \
        "  restart  - Restart all Jobsprint services" \
        "  status   - Show service status" \
        "  logs     - View and filter logs" \
        "  config   - Manage configurations" \
        "  monitor  - Real-time health dashboard" \
        "" \
        "Global options:" \
        "  -h, --help     Show this help message" \
        "  -v, --verbose  Enable verbose output" \
        "  -q, --quiet    Suppress output" \
        "" \
        "Examples:" \
        "  jobsprint start          # Start all services" \
        "  jobsprint status --watch # Watch status in real-time" \
        "  jobsprint logs n8n       # View n8n logs" \
        "  jobsprint config edit    # Manage configurations"
}

# Quick status display
show_quick_status() {
    local running=0
    local stopped=0

    for service in "${SERVICES[@]}"; do
        status=$(check_service "${service}")
        if [ "${status}" = "running" ]; then
            ((running++))
        else
            ((stopped++))
        fi
    done

    gum style \
        --foreground="${running -gt 0 ? COLOR_SUCCESS : COLOR_ERROR}" \
        --align center \
        --margin "1 2" \
        "Services: ${running} running | ${stopped} stopped"
}

# Main menu
main_menu() {
    while true; do
        clear
        show_banner
        show_quick_status
        echo ""

        local choice
        choice=$(gum choose \
            --header="Select an action:" \
            "üöÄ Start Services" \
            "üõë Stop Services" \
            "üîÑ Restart Services" \
            "üìä View Status" \
            "üìú View Logs" \
            "‚öôÔ∏è  Manage Configurations" \
            "üìà Health Monitor" \
            "‚ùì Help" \
            "üö™ Exit")

        case "${choice}" in
            "üöÄ Start Services")
                clear
                "${SCRIPT_DIR}/puter-startup"
                read -r -p "Press Enter to continue..."
                ;;
            "üõë Stop Services")
                clear
                "${SCRIPT_DIR}/puter-shutdown"
                read -r -p "Press Enter to continue..."
                ;;
            "üîÑ Restart Services")
                clear
                "${SCRIPT_DIR}/puter-shutdown" --restart
                read -r -p "Press Enter to continue..."
                ;;
            "üìä View Status")
                clear
                "${SCRIPT_DIR}/puter-status" "$@"
                read -r -p "Press Enter to continue..."
                ;;
            "üìú View Logs")
                clear
                "${SCRIPT_DIR}/puter-logs" --interactive
                ;;
            "‚öôÔ∏è  Manage Configurations")
                clear
                "${SCRIPT_DIR}/puter-config"
                ;;
            "üìà Health Monitor")
                clear
                "${SCRIPT_DIR}/puter-monitor"
                ;;
            "‚ùì Help")
                clear
                show_main_help
                read -r -p "Press Enter to continue..."
                ;;
            "üö™ Exit")
                clear
                log_info "Goodbye!"
                exit 0
                ;;
        esac
    done
}

# Command line interface
cli_mode() {
    local command="$1"
    shift

    case "${command}" in
        start|startup)
            "${SCRIPT_DIR}/puter-startup" "$@"
            ;;
        stop|shutdown)
            "${SCRIPT_DIR}/puter-shutdown" "$@"
            ;;
        restart|reload)
            "${SCRIPT_DIR}/puter-shutdown" --restart "$@"
            ;;
        status)
            "${SCRIPT_DIR}/puter-status" "$@"
            ;;
        logs|log)
            "${SCRIPT_DIR}/puter-logs" "$@"
            ;;
        config|configure)
            "${SCRIPT_DIR}/puter-config" "$@"
            ;;
        monitor|dash|dashboard)
            "${SCRIPT_DIR}/puter-monitor" "$@"
            ;;
        -h|--help|help)
            show_main_help
            ;;
        *)
            log_error "Unknown command: ${command}"
            echo ""
            echo "Use 'jobsprint --help' to see available commands"
            exit 1
            ;;
    esac
}

# Main execution
main() {
    # Check requirements
    if ! check_requirements gum; then
        error_exit "Missing required dependency: gum"
    fi

    # Parse arguments
    if [ $# -eq 0 ]; then
        # Interactive mode
        main_menu
    else
        # CLI mode
        case "$1" in
            -v|--version)
                echo "Jobsprint v${SCRIPT_VERSION}"
                ;;
            -h|--help)
                show_main_help
                ;;
            *)
                cli_mode "$@"
                ;;
        esac
    fi
}

# Run main
main "$@"
